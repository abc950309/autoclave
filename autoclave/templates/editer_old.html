<html lang="zh-CN">
<head>
<title>{{title}} - {% raw name.title() %} - 专为燕权设计的鸡汤高压釜</title>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1.0, maximum-scale=1.0"/>
<link href="//cdn.bootcss.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
<link href="//cdn.bootcss.com/font-awesome/4.4.0/css/font-awesome.min.css" rel="stylesheet">
<link href="{{ static_url('mine.css') }}" rel="stylesheet">
</head>
<body>
<nav class="navbar navbar-default navbar-fixed-top">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="#">专为燕权设计的鸡汤高压釜</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        <li><a href="/{{ name }}">首页 <span class="sr-only">(current)</span></a></li>
        <li class="active"><a href="/{{name}}/editer">编辑</a></li>
      </ul>
    </div>
  </div>
</nav>
<div class="container">
    <div class="row main-page-base">
        <div class="main-title row">
            <div class="col-sm-12">
                <i class="fa fa-pencil-square"></i> 编辑日历
                <div class="pull-right"><a href="/{{name}}/download"><i class="fa fa-download"></i> 下载图片</a> | <a href="/{{name}}"><i class="fa fa-list"></i> 今日图片</a></div>
            </div>
        </div>
        <div id="my-calendar"></div>
        <div id="cal-editer" style="display: none;">
            <div class="main-title row">
                <div class="col-sm-12">
                    <i class="fa fa-pencil-square"></i> 编辑器 - <span id="cal-editer-date"></span>
                    <div class="pull-right"><a id="hide-cal-editer" href="#">收起</a></div>
                </div>
            </div>
            <div id="cal-editer-display" style="display: none;"></div>
            <div id="cal-editer-form"></div>
        </div>
    </div>
</div>
</body>
<script type="text/javascript" src="//cdn.bootcss.com/jquery/2.1.4/jquery.min.js"></script>
<script type="text/javascript" src="//cdn.bootcss.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
<script type="text/javascript" src="{{ static_url('zabuto_calendar.min.js') }}"></script>
<link href="{{ static_url('zabuto_calendar.min.css') }}" rel="stylesheet">
    <script type="application/javascript">
        var says = "{{says}}";
        var to_says = "{{to_says}}";
        var eventData = {% raw event_data %};
        $(document).ready(function () {
            $("#my-calendar").zabuto_calendar({
                data: eventData,
                action: function () {
                    return myDateFunction(this.id);
                },
            });
            
            function myDateFunction(id) {
                clear_up_cal_editer();
                var date = $("#" + id).data("date");
                var hasEvent = $("#" + id).data("hasEvent");
                
                if (hasEvent) {
                    $("#cal-editer-display").html("<img class=\"img-responsive img-thumbnail\" src=\"/static/output/" + to_says + date + ".png\" alt=\"当日图片\" />");
                    $("#cal-editer-display").show();
                    var submit_str = "更改（图片预览还需修正，暂不可靠）";
                } else {
                    var submit_str = "生成";
                }
                
                
                $("#cal-editer-form").html("<form action=\"/{{ name }}/edit\" method=\"post\"><div class=\"form-group\"><label for=\"img-text\">文本内容</label><input name=\"text\" type=\"text\" class=\"form-control\" id=\"img-text\" placeholder=\"您希望出现在图片中的文字\"></div><input type=\"hidden\" name=\"date\" value=\"" + date + "\" /><a date-has-image=\"" + hasEvent + "\" id=\"cal-editer-submit\" class=\"btn btn-default\">" + submit_str + "</button></form>");
                
                $("#cal-editer-date").html(date);
                $("#cal-editer").show();
                
                return true;
            }
            function clear_up_cal_editer() {
                $("#cal-editer").hide();
                $("#cal-editer-display").hide();
                $("#cal-editer-display").html("");
                $("#cal-editer-form").html("");
                return true;
            }
            $("#hide-cal-editer").click(clear_up_cal_editer);
            
            $("body").on('click', '#cal-editer-submit', function(event){
                $.ajax({
                    method: "POST",
                    url: "/{{ name }}/edit",
                    data: $("form").serialize()
                });
                $("#cal-editer-display").html("<img class=\"img-responsive img-thumbnail\" src=\"/static/output/" + to_says + $("input[name=date]").val() + ".png\" alt=\"当日图片\" />");
                $("#cal-editer-display").show();
                eventData.push({"date": $("input[name=date]").val()});
            });
        });
    </script>
</html>
